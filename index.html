<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Inventory</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: rgba(255,255,255,0.02);
            --bg-hover: rgba(255,255,255,0.03);
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --text-muted: #666;
            --border-color: rgba(255,255,255,0.05);
            --purchase-color: #4ade80;
            --purchase-bg: rgba(74, 222, 128, 0.08);
            --sell-color: #f87171;
            --sell-bg: rgba(248, 113, 113, 0.08);
            --stock-color: #60a5fa;
            --header-bg: rgba(255,255,255,0.02);
        }

        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-hover: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-color: #dee2e6;
            --purchase-color: #198754;
            --purchase-bg: rgba(25, 135, 84, 0.1);
            --sell-color: #dc3545;
            --sell-bg: rgba(220, 53, 69, 0.1);
            --stock-color: #0d6efd;
            --header-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header with Theme Toggle */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 4px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        header p {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-box {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .stat-value.purchase { color: var(--purchase-color); }
        .stat-value.sell { color: var(--sell-color); }
        .stat-value.stock { color: var(--stock-color); }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.purchase { background: var(--purchase-color); }
        .legend-dot.sell { background: var(--sell-color); }

        /* Inventory Grid */
        .inventory-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 40px;
        }

        .shape-inventory {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: background 0.3s, border-color 0.3s;
        }

        .shape-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid transparent;
        }

        .shape-header:hover {
            background: var(--bg-hover);
        }

        .shape-inventory.expanded .shape-header {
            border-bottom-color: var(--border-color);
        }

        .shape-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shape-icon {
            font-size: 1.5rem;
        }

        .shape-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .shape-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .shape-total {
            text-align: right;
        }

        .shape-qty {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .shape-qty.in-stock { color: var(--purchase-color); }
        .shape-qty.low-stock { color: #fbbf24; }
        .shape-qty.out-stock { color: var(--sell-color); }

        .shape-val {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .shape-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .shape-inventory.expanded .shape-items {
            max-height: 2000px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 80px 100px 120px;
            gap: 15px;
            padding: 14px 20px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .shape-items {
            display: flex;
            flex-direction: column;
        }

        .item-row:hover {
            background: var(--bg-hover);
        }

        .item-specs {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .item-size {
            font-weight: 500;
            color: var(--text-primary);
        }

        .item-perct {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .item-rate {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'SF Mono', monospace;
        }

        .item-net {
            font-family: 'SF Mono', monospace;
            font-size: 0.95rem;
        }

        .item-net.positive { color: var(--purchase-color); }
        .item-net.zero { color: #fbbf24; }
        .item-net.negative { color: var(--sell-color); }

        .item-actions {
            text-align: right;
        }

        .view-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Transactions */
        .transactions-section {
            margin-top: 50px;
            padding-top: 40px;
            border-top: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .transaction-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .transaction-wrapper {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: background 0.3s, border-color 0.3s;
        }

        .transaction-wrapper.expanded {
            border-color: var(--text-muted);
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 85px 1fr 70px 90px 100px 100px;
            gap: 12px;
            padding: 12px 16px;
            align-items: center;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .transaction-item:hover {
            background: var(--bg-hover);
        }

        .transaction-wrapper.expanded .transaction-item {
            background: var(--bg-hover);
        }

        .transaction-item.purchase {
            border-left-color: var(--purchase-color);
        }

        .transaction-item.sell {
            border-left-color: var(--sell-color);
        }

        .tx-date {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .tx-specs {
            color: var(--text-secondary);
        }

        .tx-qty {
            font-family: 'SF Mono', monospace;
            color: var(--text-primary);
        }

        .tx-rate {
            font-family: 'SF Mono', monospace;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .tx-stock {
            font-family: 'SF Mono', monospace;
            color: var(--stock-color);
            font-size: 0.8rem;
            text-align: center;
        }

        .tx-price {
            font-family: 'SF Mono', monospace;
            text-align: right;
        }

        .tx-price.purchase { color: var(--purchase-color); }
        .tx-price.sell { color: var(--sell-color); }

        /* Inline Detail Panel */
        .tx-detail-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: var(--bg-hover);
            border-top: 1px solid var(--border-color);
        }

        .transaction-wrapper.expanded .tx-detail-panel {
            max-height: 500px;
        }

        .tx-detail-content {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-field:last-child {
            border-bottom: none;
        }

        .detail-field.full-width {
            grid-column: 1 / -1;
        }

        .detail-field-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .detail-field-value {
            font-family: 'SF Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .detail-field-value.highlight {
            font-weight: 600;
            font-size: 1rem;
        }

        .formula-note {
            grid-column: 1 / -1;
            margin-top: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .stats { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; gap: 15px; }
            .item-row { grid-template-columns: 1fr auto; }
            .item-rate { display: none; }
            .transaction-item {
                grid-template-columns: 70px 1fr 60px 80px;
                gap: 8px;
            }
            .tx-stock, .tx-rate { display: none; }
            .tx-detail-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <header>
                <h1>DIAMOND INVENTORY</h1>
                <p>Purchase & Sales Management</p>
            </header>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">ðŸŒ™</span>
                <span id="themeText">Dark</span>
            </button>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">Total Purchased</div>
                <div class="stat-value purchase" id="totalPurchase">0 ct</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Total Sold</div>
                <div class="stat-value sell" id="totalSell">0 ct</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Current Stock</div>
                <div class="stat-value stock" id="totalStock">0 ct</div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot purchase"></div>
                <span>Purchase (In)</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot sell"></div>
                <span>Sale (Out)</span>
            </div>
        </div>

        <!-- Inventory by Shape -->
        <div class="inventory-grid" id="inventoryGrid"></div>

        <!-- All Transactions -->
        <div class="transactions-section">
            <h2 class="section-title">All Transactions</h2>
            <div class="transaction-list" id="transactionList"></div>
        </div>
    </div>

    <script>
        let diamondData = [];
        let inventoryData = [];
        let stockMap = {};
        let expandedShape = null;
        let expandedTx = null;
        let currentTheme = localStorage.getItem('theme') || 'dark';

        const shapeConfig = {
            'RB': { name: 'Round Brilliant', icon: 'ðŸ’Ž' },
            'MQ': { name: 'Marquise', icon: 'ðŸ’ ' },
            'OV': { name: 'Oval', icon: 'ðŸ”·' }
        };

        // Initialize theme
        function initTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            updateThemeButton();
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (currentTheme === 'dark') {
                icon.textContent = 'ðŸŒ™';
                text.textContent = 'Dark';
            } else {
                icon.textContent = 'â˜€ï¸';
                text.textContent = 'Light';
            }
        }

        async function loadData() {
            try {
                const response = await fetch('data.json');
                diamondData = await response.json();
                inventoryData = calculateInventory(diamondData);
                buildStockMap();
                updateStats();
                renderInventory();
                renderTransactions();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function calculateInventory(data) {
            const grouped = {};
            
            data.forEach(item => {
                const key = `${item.shape}|${item.size}|${item.perCt}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        shape: item.shape,
                        size: item.size,
                        perCt: item.perCt,
                        rate: item.rate,
                        purchased: 0,
                        sold: 0,
                        netQty: 0,
                        purchaseValue: 0,
                        sellValue: 0,
                        activities: []
                    };
                }
                
                const qty = item.quantity;
                const value = item.finalPrice;
                
                if (item.type === 'Sell') {
                    grouped[key].sold += qty;
                    grouped[key].sellValue += value;
                    grouped[key].netQty -= qty;
                } else {
                    grouped[key].purchased += qty;
                    grouped[key].purchaseValue += value;
                    grouped[key].netQty += qty;
                }
                
                grouped[key].activities.push(item);
            });

            return Object.values(grouped);
        }

        function buildStockMap() {
            stockMap = {};
            inventoryData.forEach(item => {
                const key = `${item.shape}|${item.size}|${item.perCt}`;
                stockMap[key] = item.netQty;
            });
        }

        function updateStats() {
            let purchased = 0, sold = 0;
            
            inventoryData.forEach(item => {
                purchased += item.purchased;
                sold += item.sold;
            });
            
            document.getElementById('totalPurchase').textContent = purchased.toFixed(3) + ' ct';
            document.getElementById('totalSell').textContent = sold.toFixed(3) + ' ct';
            document.getElementById('totalStock').textContent = (purchased - sold).toFixed(3) + ' ct';
        }

        function formatCurrency(value) {
            if (!value) return 'MMK 0';
            return 'MMK ' + value.toLocaleString('en-US');
        }

        function formatDate(serial) {
            if (!serial) return '-';
            const date = new Date((serial - 25569) * 86400 * 1000);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getStockClass(qty) {
            if (qty <= 0) return 'out-stock';
            if (qty < 1) return 'low-stock';
            return 'in-stock';
        }

        function getNetClass(qty) {
            if (qty > 0) return 'positive';
            if (qty === 0) return 'zero';
            return 'negative';
        }

        function getItemStock(shape, size, perCt) {
            const key = `${shape}|${size}|${perCt}`;
            return stockMap[key] || 0;
        }

        function renderInventory() {
            const shapes = [...new Set(inventoryData.map(d => d.shape))];
            const container = document.getElementById('inventoryGrid');
            
            container.innerHTML = shapes.map((shape, index) => {
                const config = shapeConfig[shape] || { name: shape, icon: 'ðŸ’Ž' };
                const items = inventoryData.filter(d => d.shape === shape);
                const totalQty = items.reduce((sum, d) => sum + d.netQty, 0);
                const totalVal = items.reduce((sum, d) => sum + d.purchaseValue - d.sellValue, 0);
                
                return `
                    <div class="shape-inventory" id="shape-${index}">
                        <div class="shape-header" onclick="toggleShape(${index})">
                            <div class="shape-info">
                                <span class="shape-icon">${config.icon}</span>
                                <div>
                                    <div class="shape-title">${shape} - ${config.name}</div>
                                    <div class="shape-subtitle">${items.length} variants</div>
                                </div>
                            </div>
                            <div class="shape-total">
                                <div class="shape-qty ${getStockClass(totalQty)}">${totalQty.toFixed(3)} ct</div>
                                <div class="shape-val">${formatCurrency(totalVal)}</div>
                            </div>
                        </div>
                        <div class="shape-items">
                            ${items.map(item => `
                                <div class="item-row">
                                    <div class="item-specs">
                                        <div class="item-size">${item.size} mm</div>
                                        <div class="item-perct">${item.perCt}/ct</div>
                                    </div>
                                    <div class="item-rate">${formatCurrency(item.rate)}</div>
                                    <div class="item-net ${getNetClass(item.netQty)}">
                                        ${item.netQty > 0 ? '+' : ''}${item.netQty.toFixed(3)} ct
                                    </div>
                                    <div class="item-actions">
                                        <button class="view-btn" onclick="event.stopPropagation(); viewActivities('${item.shape}', '${item.size}', '${item.perCt}')">View</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleShape(index) {
            const shape = document.getElementById(`shape-${index}`);
            if (expandedShape !== null && expandedShape !== index) {
                document.getElementById(`shape-${expandedShape}`).classList.remove('expanded');
            }
            shape.classList.toggle('expanded');
            expandedShape = shape.classList.contains('expanded') ? index : null;
        }

        function viewActivities(shape, size, perCt) {
            const item = inventoryData.find(d => d.shape === shape && d.size === size && d.perCt === perCt);
            if (!item) return;
            
            // Find the clicked button and its item row
            const clickedBtn = event.target;
            const itemRow = clickedBtn.closest('.item-row');
            if (!itemRow) return;
            
            // Check if this item already has an activity panel
            let existingPanel = itemRow.nextElementSibling;
            if (existingPanel && existingPanel.classList.contains('activity-panel-inline')) {
                existingPanel.remove();
                return;
            }
            
            // Remove any other activity panels
            document.querySelectorAll('.activity-panel-inline').forEach(el => el.remove());
            
            // Create activity panel
            const panel = document.createElement('div');
            panel.className = 'activity-panel-inline';
            panel.style.cssText = `
                background: var(--bg-hover);
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                padding: 15px 20px;
                animation: slideDown 0.3s ease;
                grid-column: 1 / -1;
            `;
            
            let activitiesHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 0.8rem; font-weight: 500; color: var(--text-primary);">
                        Activity History
                    </span>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">
                        Net Stock: <span style="color: ${item.netQty >= 0 ? 'var(--purchase-color)' : 'var(--sell-color)'}; font-weight: 600;">${item.netQty.toFixed(3)} ct</span>
                    </span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 6px;">
            `;
            
            item.activities.sort((a, b) => b.date - a.date).forEach(act => {
                const isSell = act.type === 'Sell';
                activitiesHtml += `
                    <div style="
                        display: grid;
                        grid-template-columns: 90px 55px 1fr auto;
                        gap: 12px;
                        padding: 10px 12px;
                        background: var(--bg-secondary);
                        border-radius: 6px;
                        align-items: center;
                        font-size: 0.8rem;
                        border-left: 2px solid ${isSell ? 'var(--sell-color)' : 'var(--purchase-color)'};
                    ">
                        <span style="color: var(--text-muted);">${formatDate(act.date)}</span>
                        <span style="
                            padding: 2px 5px;
                            border-radius: 3px;
                            font-size: 0.6rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            text-align: center;
                            background: ${isSell ? 'var(--sell-bg)' : 'var(--purchase-bg)'};
                            color: ${isSell ? 'var(--sell-color)' : 'var(--purchase-color)'};
                        ">${act.type}</span>
                        <span style="color: var(--text-secondary);">${act.quantity.toFixed(3)} ct Ã— ${formatCurrency(act.rate)}</span>
                        <span style="font-family: 'SF Mono', monospace; color: ${isSell ? 'var(--sell-color)' : 'var(--purchase-color)'}; text-align: right;">
                            ${isSell ? '-' : '+'}${formatCurrency(act.finalPrice)}
                        </span>
                    </div>
                `;
            });
            
            activitiesHtml += `</div>`;
            panel.innerHTML = activitiesHtml;
            
            // Insert right after the item row
            itemRow.after(panel);
        }

        function renderTransactions() {
            const list = document.getElementById('transactionList');
            list.innerHTML = diamondData
                .sort((a, b) => b.date - a.date)
                .map((tx, idx) => {
                    const stock = getItemStock(tx.shape, tx.size, tx.perCt);
                    return `
                        <div class="transaction-wrapper" id="tx-${idx}">
                            <div class="transaction-item ${tx.type.toLowerCase()}" onclick="toggleTransaction(${idx})">
                                <div class="tx-date">${formatDate(tx.date)}</div>
                                <div class="tx-specs">${tx.shape} ${tx.size}mm | ${tx.perCt}/ct</div>
                                <div class="tx-qty">${tx.quantity.toFixed(2)}</div>
                                <div class="tx-rate">${formatCurrency(tx.rate)}</div>
                                <div class="tx-stock">Stock: ${stock.toFixed(2)}</div>
                                <div class="tx-price ${tx.type.toLowerCase()}">
                                    ${tx.type === 'Sell' ? '-' : '+'}${formatCurrency(tx.finalPrice)}
                                </div>
                            </div>
                            <div class="tx-detail-panel" id="tx-panel-${idx}">
                                ${renderTransactionDetail(tx, stock)}
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderTransactionDetail(tx, stock) {
            const isSell = tx.type === 'Sell';
            const adjPerCt = tx.adjustedPerCt || (parseFloat(tx.perCt) * 1.1);
            
            let html = '<div class="tx-detail-content">';
            
            html += `
                <div class="detail-field">
                    <span class="detail-field-label">Type</span>
                    <span class="detail-field-value" style="color: ${isSell ? 'var(--sell-color)' : 'var(--purchase-color)'}; font-weight: 600;">${tx.type}</span>
                </div>
                <div class="detail-field">
                    <span class="detail-field-label">Date</span>
                    <span class="detail-field-value">${formatDate(tx.date)}</span>
                </div>
                <div class="detail-field">
                    <span class="detail-field-label">Shape</span>
                    <span class="detail-field-value">${tx.shape}</span>
                </div>
                <div class="detail-field">
                    <span class="detail-field-label">Size</span>
                    <span class="detail-field-value">${tx.size} mm</span>
                </div>
                <div class="detail-field">
                    <span class="detail-field-label">Per Carat</span>
                    <span class="detail-field-value">${tx.perCt}</span>
                </div>
                <div class="detail-field">
                    <span class="detail-field-label">Quantity</span>
                    <span class="detail-field-value">${tx.quantity.toFixed(3)} ct</span>
                </div>
            `;
            
            if (isSell) {
                html += `
                    <div class="detail-field">
                        <span class="detail-field-label">Change Unit</span>
                        <span class="detail-field-value">${tx.changeUnit || 1.1}x</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Adjusted Per Ct</span>
                        <span class="detail-field-value">${adjPerCt.toFixed(2)}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Rate</span>
                        <span class="detail-field-value">${formatCurrency(tx.rate)}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Original Value</span>
                        <span class="detail-field-value">${formatCurrency(tx.originalPrice)}</span>
                    </div>
                    <div class="formula-note">
                        Formula: ${tx.quantity.toFixed(3)} ct Ã— ${tx.perCt} Ã— 1.1 Ã— ${formatCurrency(tx.rate).replace('MMK ', '')} = ${formatCurrency(tx.finalPrice)}
                    </div>
                `;
            } else {
                html += `
                    <div class="detail-field">
                        <span class="detail-field-label">Rate</span>
                        <span class="detail-field-value">${formatCurrency(tx.rate)}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Discount Rate</span>
                        <span class="detail-field-value">${(tx.discountRate * 100).toFixed(0)}%</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Original Price</span>
                        <span class="detail-field-value">${formatCurrency(tx.originalPrice)}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-field-label">Discount</span>
                        <span class="detail-field-value" style="color: var(--sell-color);">-${formatCurrency(tx.discountPrice)}</span>
                    </div>
                `;
            }
            
            html += `
                <div class="detail-field full-width" style="border-top: 1px solid var(--border-color); margin-top: 10px; padding-top: 15px;">
                    <span class="detail-field-label">Final Price</span>
                    <span class="detail-field-value highlight" style="color: ${isSell ? 'var(--sell-color)' : 'var(--purchase-color)'}">${formatCurrency(tx.finalPrice)}</span>
                </div>
                <div class="detail-field full-width">
                    <span class="detail-field-label">Current Stock for this Item</span>
                    <span class="detail-field-value" style="color: ${stock > 0 ? 'var(--purchase-color)' : 'var(--sell-color)'}; font-weight: 600;">${stock.toFixed(3)} ct</span>
                </div>
            </div>`;
            
            return html;
        }

        function toggleTransaction(idx) {
            const wrapper = document.getElementById(`tx-${idx}`);
            
            if (expandedTx !== null && expandedTx !== idx) {
                document.getElementById(`tx-${expandedTx}`).classList.remove('expanded');
            }
            
            wrapper.classList.toggle('expanded');
            expandedTx = wrapper.classList.contains('expanded') ? idx : null;
        }

        // Initialize
        initTheme();
        loadData();
    </script>
</body>
</html>